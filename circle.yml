machine:
  timezone:
      Europe/Berlin

  php:
    version: 7.1.3

  hosts:
    ixde.dev: 127.0.0.1

dependencies:
  cache_directories:
    - ~/.composer/cache

  pre:
    - rm /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini
    - mysql -u ubuntu -e "create database ix_de"
    - echo "memory_limit = 512M" > /opt/circleci/php/$(phpenv global)/etc/conf.d/memory.ini

    # Restart Apache to pickup new config
    - sudo cp ./circle.conf /etc/apache2/sites-available
    - sudo rm /etc/apache2/mods-enabled/php5.load
    - sudo service apache2 start
    - sudo a2ensite circle
    - sudo service apache2 reload
    - sudo a2enmod rewrite
    - sudo service apache2 restart

  post:
    # Make Composer executables available globally.
    - echo "export PATH=$PATH:$HOME/${CIRCLE_PROJECT_REPONAME}/bin" >> /home/ubuntu/.bashrc
    - source /home/ubuntu/.bashrc

    - cd ./web && drush si standard --db-url=mysql://ubuntu:@127.0.0.1/ix_de --account-name='ubuntu' --account-pass='NO' --site-name=ixde.dev -y
    - cd ./web && drush config-set system.performance css.preprocess 0 -y
    - cd ./web && drush config-set system.performance js.preprocess 0 -y

    - cp ./circle.htaccess $HOME/${CIRCLE_PROJECT_REPONAME}/web/.htaccess

test:
  override:
    - cd ./tests && behat

deployment:
  dev:
    branch: develop
    commands:
      - ssh ix@89.19.229.211 'cd /var/www/html/d8-test/scripts/deploy && . develop.sh'

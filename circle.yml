## Customize the test machine
machine:
  timezone:
      Europe/Berlin

  php:
    # Default: 5.6.17 @see https://circleci.com/docs/1.0/build-image-trusty/#php
    version: 7.1.3

  hosts:
    ixde.dev: 127.0.0.1

dependencies:
  cache_directories:
    # Caching composer dependencies
    - ~/.composer/cache
  pre:
    # Disable Xdebug @see https://circleci.com/docs/1.0/language-php/#xdebug
    - rm /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini

    # No password is required for the MySQL user `ubuntu`
    - mysql -u ubuntu -e "create database ix_de"

    - echo "memory_limit = 512M" > /opt/circleci/php/$(phpenv global)/etc/conf.d/memory.ini

    # Copy Apache vhost config

    - sudo cp ./circle.conf /etc/apache2/sites-available/000-default.conf

    # Restart Apache to pickup new config
    - sudo rm /etc/apache2/mods-enabled/php5.load
#    - sudo a2ensite circle.conf
    - sudo a2enmod rewrite
    - sudo service apache2 restart


  post:
    # Make Composer executables available globally.
    - echo "export PATH=$PATH:$HOME/${CIRCLE_PROJECT_REPONAME}/bin" >> /home/ubuntu/.bashrc
    - source /home/ubuntu/.bashrc

    # Each command is run in a separate shell, which means they do not share environments with preceding commands. @see https://circleci.com/docs/1.0/configuration/#phases
    - cd ./web && drush si standard --db-url=mysql://ubuntu:@127.0.0.1/ix_de --account-name='ubuntu' --account-pass='NO' --site-name=ixde.dev -y
    - cd ./web && drush config-set system.performance css.preprocess 0 -y
    - cd ./web && drush config-set system.performance js.preprocess 0 -y

    - cp ./circle.htaccess $HOME/${CIRCLE_PROJECT_REPONAME}/web/.htaccess

test:
  override:
    - cd ./tests && behat

# These commands are triggered only after a successful (green) build.
deployment:
  dev:
    branch: develop
    commands:
      - ssh ix@89.19.229.211 'cd /var/www/html/d8-test/scripts/deploy && . develop.sh'

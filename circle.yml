## Customize the test machine
machine:
  php:
    # Default: 5.6.17 @see https://circleci.com/docs/1.0/build-image-trusty/#php
    version: 7.1.3
  hosts:
    # This will be added to the `/etc/hosts` file
    ixde.dev: 127.0.0.1

dependencies:
  cache_directories:
    # Caching composer dependencies
    - ~/.composer/cache
  pre:
    # Disable Xdebug @see https://circleci.com/docs/1.0/language-php/#xdebug
    - rm /opt/circleci/php/$(phpenv global)/etc/conf.d/xdebug.ini
    # No password is required for the MySQL user `ubuntu`
    - mysql -u ubuntu -e "create database ix_de"
  post:
    # Make Composer executables available globally.
    - echo "export PATH=$PATH:$HOME/${CIRCLE_PROJECT_REPONAME}/bin" >> /home/ubuntu/.bashrc
    - source /home/ubuntu/.bashrc

    # Each command is run in a separate shell, which means they do not share environments with preceding commands. @see https://circleci.com/docs/1.0/configuration/#phases
    - cd ./web && drush si standard --db-url=mysql://ubuntu:@127.0.0.1/ix_de --account-name='ubuntu' --account-pass='' --site-name=ixde.dev -y
    - cd ./web && drush config-set system.performance css.preprocess 0 -y
    - cd ./web && drush config-set system.performance js.preprocess 0 -y

    # get selenium rocking!
    - wget http://selenium-release.storage.googleapis.com/2.47/selenium-server-standalone-2.47.1.jar
    - 'java -jar selenium-server-standalone-2.47.1.jar > /dev/null 2>&1':
          background: true

    - sudo a2enmod rewrite
    - sudo rm /etc/apache2/mods-enabled/php5.load
    # Copy Apache conf into `site-available`
    - sudo cp ./circle.conf /etc/apache2/sites-available
    # Use `a2ensite` to create a symlink for the config
    - sudo a2ensite circle.conf
    # Restart the Apache server
    - sudo service apache2 restart

test:
  pre:
    - mkdir behat_screenshots
    - chmod 777 behat_screenshots
    - export BEHAT_SCREENSHOTS="1"
  override:
    - cd ./tests && behat
  post:
    # add a file so that the directory isn't empty (else copy will fail)
    - touch ../behat_screenshots/keep
    - cp ../behat_screenshots/* $CIRCLE_ARTIFACTS/
    - rm $CIRCLE_ARTIFACTS/keep

# These commands are triggered only after a successful (green) build.
deployment:
  dev:
    branch: develop
    commands:
      - ssh ix@89.19.229.211 'cd /var/www/html/d8-test/scripts/deploy && . develop.sh'
